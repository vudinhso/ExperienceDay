<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Joystick test</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript" src="joy.js"></script>
  </head>

  <body>
    <!-- Logo -->
    <div>
      <img src="RMIT-Logo.png" alt="RMIT-Logo" class="center" />
    </div>
    <!-- Slider -->
    <div style="padding-top: 5em">
      <div class="slidecontainer">
        <input
          type="range"
          min="-100"
          max="100"
          value="0"
          class="slider"
          id="myRange"
        />
        <p style="text-align: center">Value: <span id="demo"></span></p>
      </div>
    </div>

    <!-- Joystick -->
    <!-- <div id="outerContainer"> -->
    <div>
      <div style="padding-top: 1em"></div>
      <div id="joyDiv" style="width: 250px; height: 250px; margin: auto"></div>
    </div>

    <script>
      var slider = document.getElementById("myRange");
      var output = document.getElementById("demo");

      slider.oninput = function () {
        output.innerHTML = slider.value;
        output.innerHTML = this.value;
      };
      slider.onchange = function () {
        document.getElementById("myRange").value = 0;
        output.innerHTML = 0;
      };
    </script>

    <script>
      const view = document.getElementById("stream");
      const WS_URL = "ws://" + window.location.host + ":82";
      const ws = new WebSocket(WS_URL);

      ws.onmessage = (message) => {
        if (message.data instanceof Blob) {
          var urlObject = URL.createObjectURL(message.data);
          view.src = urlObject;
        }
      };

      var lastText, lastSend, sendTimeout;

      function send(txt) {
        var now = new Date().getTime();
        if (lastSend === undefined || now - lastSend >= 30) {
          try {
            ws.send(txt);
            lastSend = new Date().getTime();
            return;
          } catch (e) {
            console.log(e);
          }
        }
        lastText = txt;
        if (!sendTimeout) {
          var ms = lastSend !== undefined ? 30 - (now - lastSend) : 30;
          if (ms < 0) ms = 0;
          sendTimeout = setTimeout(() => {
            sendTimeout = null;
            send(lastText);
          }, ms);
        }
      }
    </script>
  </body>

  <script type="text/javascript">
    // Create JoyStick object into the DIV 'joyDiv'
    var joy = new JoyStick("joyDiv");

    function getfuerza(nJoyX, nJoyY) {
      var nMotMixL;
      var nMotMixR;
      var fPivYLimit = 32.0; //The threshold at which the pivot action starts
      //                This threshold is measured in units on the Y-axis
      //                away from the X-axis (Y=0). A greater value will assign
      //                more of the joystick's range to pivot actions.
      //                Allowable range: (0..+127)

      // TEMP VARIABLES
      var nMotPremixL; // Motor (left)  premixed output        (-128..+127)
      var nMotPremixR; // Motor (right) premixed output        (-128..+127)
      var nPivSpeed; // Pivot Speed                          (-128..+127)
      var fPivScale; // Balance scale b/w drive and pivot    (   0..1   )

      // Calculate Drive Turn output due to Joystick X input
      if (nJoyY >= 0) {
        // Forward
        nMotPremixL = nJoyX >= 0 ? 100.0 : 100.0 + parseFloat(nJoyX);
        nMotPremixR = nJoyX >= 0 ? 100.0 - nJoyX : 100.0;
      } else {
        // Reverse
        nMotPremixL = nJoyX >= 0 ? 100.0 - nJoyX : 100.0;
        nMotPremixR = nJoyX >= 0 ? 100.0 : 100.0 + parseFloat(nJoyX);
      }

      // Scale Drive output due to Joystick Y input (throttle)
      nMotPremixL = (nMotPremixL * nJoyY) / 100.0;
      nMotPremixR = (nMotPremixR * nJoyY) / 100.0;

      // Now calculate pivot amount
      // - Strength of pivot (nPivSpeed) based on Joystick X input
      // - Blending of pivot vs drive (fPivScale) based on Joystick Y input
      nPivSpeed = nJoyX;
      fPivScale =
        Math.abs(nJoyY) > fPivYLimit ? 0.0 : 1.0 - Math.abs(nJoyY) / fPivYLimit;

      // Calculate final mix of Drive and Pivot
      nMotMixL = (1.0 - fPivScale) * nMotPremixL + fPivScale * nPivSpeed;
      nMotMixR = (1.0 - fPivScale) * nMotPremixR + fPivScale * -nPivSpeed;

      return Math.round(nMotMixL * 2.55) + "," + Math.round(nMotMixR * 2.55); // The function returns the product of p1 and p2
    }

    // setInterval(function () { send(getfuerza(joy.GetX(), joy.GetY())); }, 300);
    setInterval(function () {
      send(joy.GetX() + "," + joy.GetY() + "," + myRange.value);
    }, 100);
  </script>
</html>
